const h=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],c=["#FFCBA4","#E2725B","#FBCEB1","#F4D03F","#7FCDCD","#93E9BE","#4A9B9B","#63B3B3","#DCAE96","#B2C9AB","#C5B4E3","#F8EDD3"];class y{element;stepIndex;stepState;colorConfig;callbacks;interactionLevel=0;rowActivity=0;hue;longPressTimer=null;longPressDuration=500;isLongPress=!1;touchHandled=!1;indicatorSvg=null;indicatorPaths=[];constructor(t,e,s,n){this.stepIndex=t,this.stepState={...e},this.colorConfig=s,this.callbacks=n,s.mode==="hue"?this.hue=s.hue:this.hue=this.extractHueFromHex(s.character.baseColor),this.element=document.createElement("button"),this.element.className=this.getButtonClassName(),this.element.setAttribute("data-step",t.toString()),this.element.setAttribute("aria-label",`Step ${t+1}`),this.element.addEventListener("click",i=>{this.touchHandled||this.handleClick(),this.touchHandled=!1}),this.element.addEventListener("touchstart",i=>{this.handleLongPressStart(i)}),this.element.addEventListener("touchend",i=>{this.handleLongPressEnd(i)}),this.element.addEventListener("touchcancel",()=>{this.clearLongPressTimer()}),this.element.addEventListener("mousedown",i=>{this.handleLongPressStart(i)}),this.element.addEventListener("mouseup",i=>{this.handleLongPressEnd(i)}),this.element.addEventListener("mouseleave",()=>{this.clearLongPressTimer()}),this.element.addEventListener("contextmenu",i=>{i.preventDefault()}),this.createIndicator(),this.updateState()}handleClick(){if(this.isLongPress){this.isLongPress=!1;return}let t=this.stepState.noteIndex+1;t>11&&(t=-1);const e=t>=0;this.stepState={isActive:e,noteIndex:t,pressCount:this.stepState.pressCount+1},this.colorConfig.mode==="hue"&&e&&(this.hue=t*30),this.updateState(),this.callbacks.onStateChange(this.stepIndex,{...this.stepState}),e&&this.callbacks.onPlayPreview&&this.callbacks.onPlayPreview(t)}handleLongPressStart(t){this.clearLongPressTimer(),this.isLongPress=!1,this.touchHandled=!1,t.type==="touchstart"&&t.preventDefault(),this.longPressTimer=window.setTimeout(()=>{this.handleLongPress()},this.longPressDuration)}handleLongPressEnd(t){const e=this.longPressTimer!==null;this.longPressTimer!==null&&this.clearLongPressTimer(),t.type==="touchend"&&t.preventDefault(),e&&!this.isLongPress&&t.type==="touchend"&&(this.touchHandled=!0,this.handleClick())}clearLongPressTimer(){this.longPressTimer!==null&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)}handleLongPress(){this.clearLongPressTimer(),this.isLongPress=!0,this.stepState={isActive:!1,noteIndex:-1,pressCount:this.stepState.pressCount+1},this.updateState(),this.callbacks.onStateChange(this.stepIndex,{...this.stepState})}getButtonClassName(){return this.colorConfig.mode==="character"?"step-button character-mode":"step-button"}extractHueFromHex(t){const e=parseInt(t.slice(1,3),16)/255,s=parseInt(t.slice(3,5),16)/255,n=parseInt(t.slice(5,7),16)/255,i=Math.max(e,s,n),r=Math.min(e,s,n);let a=0;if(i!==r){const o=i-r;switch(i){case e:a=((s-n)/o+(s<n?6:0))/6;break;case s:a=((n-e)/o+2)/6;break;case n:a=((e-s)/o+4)/6;break}}return Math.round(a*360)}getElement(){return this.element}setStepState(t){this.stepState={...t},this.updateState()}getStepState(){return{...this.stepState}}getNoteName(){return h[this.stepState.noteIndex]||"C"}setCurrentStep(t){this.element.classList.toggle("current-step",t)}setInteractionLevel(t,e=0){this.interactionLevel=t,this.rowActivity=e,this.updateState()}updateState(){this.element.classList.remove("active","inactive"),this.stepState.isActive?this.element.classList.add("active"):this.element.classList.add("inactive"),this.colorConfig.mode==="character"?this.applyCharacterColor():this.applyHueColor(),this.updateContent(),this.stepState.isActive?this.element.classList.add("glow-active"):this.element.classList.remove("glow-active"),this.updateIndicator()}applyHueColor(){if(!this.stepState.isActive||this.stepState.noteIndex===-1){this.element.style.backgroundColor="",this.element.style.color="";return}const t=c[this.stepState.noteIndex];this.element.style.backgroundColor=t,this.element.style.color="#333333"}applyCharacterColor(){if(this.colorConfig.mode!=="character")return;if(!this.stepState.isActive||this.stepState.noteIndex===-1){this.element.style.backgroundColor="",this.element.style.color="";return}const t=c[this.stepState.noteIndex];this.element.style.backgroundColor=t,this.element.style.color="#333333"}calculateSaturation(){return this.stepState.isActive?100:0}calculateLightness(){if(!this.stepState.isActive)return 20;let t=55;switch(this.interactionLevel){case 0:return 55;case 1:t=58;break;case 2:t=62;break;case 3:t=66;break;case 4:t=70;break;case 5:t=75;break;default:t=55}const e=this.rowActivity*15;return Math.min(t+e,90)}updateContent(){if(this.colorConfig.mode==="character")this.renderCharacterContent();else{const t=this.element.querySelector(".step-button-indicator");this.element.innerHTML="",t&&this.element.appendChild(t);const e=this.getNoteName();this.element.setAttribute("aria-label",`Step ${this.stepIndex+1} - ${e} (${this.stepState.pressCount} presses)`)}}renderCharacterContent(){if(this.colorConfig.mode!=="character")return;const t=this.colorConfig.character;if(!this.stepState.isActive||this.stepState.noteIndex===-1){const i=this.element.querySelector(".step-button-indicator");this.element.innerHTML="",i&&this.element.appendChild(i),this.element.setAttribute("aria-label",`Step ${this.stepIndex+1} - ${t.name} (off)`);return}const e=document.createElement("div");e.className="step-note-label",t.canPitch&&this.stepState.noteIndex>=0?e.textContent=h[this.stepState.noteIndex]:e.textContent="♪";const s=this.element.querySelector(".step-button-indicator");this.element.innerHTML="",this.element.appendChild(e),s&&this.element.appendChild(s);const n=t.canPitch?h[this.stepState.noteIndex]:"♪";this.element.setAttribute("aria-label",`Step ${this.stepIndex+1} - ${t.name} - ${n}`)}createIndicator(){const t=document.createElement("div");t.className="step-button-indicator",this.indicatorSvg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.indicatorSvg.setAttribute("viewBox","0 0 100 100"),this.indicatorSvg.setAttribute("preserveAspectRatio","none"),this.indicatorSvg.style.width="100%",this.indicatorSvg.style.height="100%",this.indicatorSvg.style.position="absolute",this.indicatorSvg.style.top="0",this.indicatorSvg.style.left="0",this.indicatorSvg.style.pointerEvents="none",this.indicatorSvg.style.overflow="visible";const e=50,s=50,n=48,i=n-3;for(let r=0;r<12;r++){const a=(r*30-90)*(Math.PI/180),o=((r+1)*30-90)*(Math.PI/180),u=e+n*Math.cos(a),p=s+n*Math.sin(a),m=e+n*Math.cos(o),g=s+n*Math.sin(o),S=e+i*Math.cos(o),v=s+i*Math.sin(o),f=e+i*Math.cos(a),C=s+i*Math.sin(a),l=document.createElementNS("http://www.w3.org/2000/svg","path"),d=0,b=`
        M ${u} ${p}
        A ${n} ${n} 0 ${d} 1 ${m} ${g}
        L ${S} ${v}
        A ${i} ${i} 0 ${d} 0 ${f} ${C}
        Z
      `.trim();l.setAttribute("d",b),l.setAttribute("fill","#E0E0E0"),l.setAttribute("stroke","none"),l.setAttribute("class",`indicator-segment indicator-segment-${r}`),this.indicatorSvg.appendChild(l),this.indicatorPaths.push(l)}t.appendChild(this.indicatorSvg),this.element.appendChild(t),this.stepState.noteIndex===-1&&(t.style.display="none")}updateIndicator(){if(!this.indicatorSvg||this.indicatorPaths.length===0)return;const t=this.element.querySelector(".step-button-indicator");if(t){if(this.stepState.noteIndex===-1){t.style.display="none";return}t.style.display="block";for(let e=0;e<12;e++){const s=this.indicatorPaths[e];if(s)if(e===this.stepState.noteIndex){const n=c[this.stepState.noteIndex];s.setAttribute("fill",n),s.setAttribute("opacity","1")}else s.setAttribute("fill","#E0E0E0"),s.setAttribute("opacity","0.5")}}}}export{y as S};
