const g=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],l=["#FFCBA4","#E2725B","#FBCEB1","#F4D03F","#7FCDCD","#93E9BE","#4A9B9B","#63B3B3","#DCAE96","#B2C9AB","#C5B4E3","#F8EDD3"];class y{wrapper;element;stepIndex;stepState;colorConfig;callbacks;interactionLevel=0;rowActivity=0;hue;longPressTimer=null;longPressDuration=500;isLongPress=!1;touchHandled=!1;indicatorSvg=null;indicatorPaths=[];progressRingContainer=null;progressRingSvg=null;progressRingBg=null;progressRingPath=null;progressPerimeter=0;constructor(t,e,s,n){this.stepIndex=t,this.stepState={...e},this.colorConfig=s,this.callbacks=n,s.mode==="hue"?this.hue=s.hue:this.hue=this.extractHueFromHex(s.character.baseColor),this.wrapper=document.createElement("div"),this.wrapper.className="step-button-wrapper",this.element=document.createElement("button"),this.element.className=this.getButtonClassName(),this.element.setAttribute("data-step",t.toString()),this.element.setAttribute("aria-label",`Step ${t+1}`),this.element.addEventListener("click",i=>{this.touchHandled||this.handleClick(),this.touchHandled=!1}),this.element.addEventListener("touchstart",i=>{this.handleLongPressStart(i)}),this.element.addEventListener("touchend",i=>{this.handleLongPressEnd(i)}),this.element.addEventListener("touchcancel",()=>{this.clearLongPressTimer()}),this.element.addEventListener("mousedown",i=>{this.handleLongPressStart(i)}),this.element.addEventListener("mouseup",i=>{this.handleLongPressEnd(i)}),this.element.addEventListener("mouseleave",()=>{this.clearLongPressTimer()}),this.element.addEventListener("contextmenu",i=>{i.preventDefault()}),this.wrapper.appendChild(this.element),this.createProgressRing(),this.updateState()}handleClick(){if(this.isLongPress){this.isLongPress=!1;return}let t=this.stepState.noteIndex+1;t>11&&(t=-1);const e=t>=0;this.stepState={isActive:e,noteIndex:t,pressCount:e?t+1:0},this.colorConfig.mode==="hue"&&e&&(this.hue=t*30),this.updateState(),this.callbacks.onStateChange(this.stepIndex,{...this.stepState}),e&&this.callbacks.onPlayPreview&&this.callbacks.onPlayPreview(t)}handleLongPressStart(t){this.clearLongPressTimer(),this.isLongPress=!1,this.touchHandled=!1,t.type==="touchstart"&&t.preventDefault(),this.longPressTimer=window.setTimeout(()=>{this.handleLongPress()},this.longPressDuration)}handleLongPressEnd(t){const e=this.longPressTimer!==null;this.longPressTimer!==null&&this.clearLongPressTimer(),t.type==="touchend"&&t.preventDefault(),e&&!this.isLongPress&&t.type==="touchend"&&(this.touchHandled=!0,this.handleClick())}clearLongPressTimer(){this.longPressTimer!==null&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)}handleLongPress(){this.clearLongPressTimer(),this.isLongPress=!0,this.stepState={isActive:!1,noteIndex:-1,pressCount:0},this.updateState(),this.callbacks.onStateChange(this.stepIndex,{...this.stepState})}getButtonClassName(){return this.colorConfig.mode==="character"?"step-button character-mode":"step-button"}extractHueFromHex(t){const e=parseInt(t.slice(1,3),16)/255,s=parseInt(t.slice(3,5),16)/255,n=parseInt(t.slice(5,7),16)/255,i=Math.max(e,s,n),r=Math.min(e,s,n);let o=0;if(i!==r){const a=i-r;switch(i){case e:o=((s-n)/a+(s<n?6:0))/6;break;case s:o=((n-e)/a+2)/6;break;case n:o=((e-s)/a+4)/6;break}}return Math.round(o*360)}getElement(){return this.wrapper}setStepState(t){this.stepState={...t},this.updateState()}getStepState(){return{...this.stepState}}getNoteName(){return g[this.stepState.noteIndex]||"C"}setCurrentStep(t){this.element.classList.toggle("current-step",t)}setInteractionLevel(t,e=0){this.interactionLevel=t,this.rowActivity=e,this.updateState()}updateState(){this.element.classList.remove("active","inactive"),this.stepState.isActive?this.element.classList.add("active"):this.element.classList.add("inactive"),this.colorConfig.mode==="character"?this.applyCharacterColor():this.applyHueColor(),this.updateContent(),this.stepState.isActive?this.element.classList.add("glow-active"):this.element.classList.remove("glow-active"),this.updateIndicator(),this.updateProgressRing()}applyHueColor(){if(!this.stepState.isActive||this.stepState.noteIndex===-1){this.element.style.backgroundColor="",this.element.style.color="";return}const t=l[this.stepState.noteIndex];this.element.style.backgroundColor=t,this.element.style.color="#333333"}applyCharacterColor(){if(this.colorConfig.mode!=="character")return;if(!this.stepState.isActive||this.stepState.noteIndex===-1){this.element.style.backgroundColor="",this.element.style.color="";return}const t=l[this.stepState.noteIndex];this.element.style.backgroundColor=t,this.element.style.color="#333333"}calculateSaturation(){return this.stepState.isActive?100:0}calculateLightness(){if(!this.stepState.isActive)return 20;let t=55;switch(this.interactionLevel){case 0:return 55;case 1:t=58;break;case 2:t=62;break;case 3:t=66;break;case 4:t=70;break;case 5:t=75;break;default:t=55}const e=this.rowActivity*15;return Math.min(t+e,90)}updateContent(){if(this.colorConfig.mode==="character")this.renderCharacterContent();else{const t=this.element.querySelector(".step-button-indicator");this.element.innerHTML="",t&&this.element.appendChild(t);const e=this.getNoteName();this.element.setAttribute("aria-label",`Step ${this.stepIndex+1} - ${e} (${this.stepState.pressCount} presses)`)}}renderCharacterContent(){if(this.colorConfig.mode!=="character")return;const t=this.colorConfig.character;if(!this.stepState.isActive||this.stepState.noteIndex===-1){const i=this.element.querySelector(".step-button-indicator");this.element.innerHTML="",i&&this.element.appendChild(i),this.element.setAttribute("aria-label",`Step ${this.stepIndex+1} - ${t.name} (off)`);return}const e=document.createElement("div");e.className="step-note-label",t.canPitch&&this.stepState.noteIndex>=0?e.textContent=g[this.stepState.noteIndex]:e.textContent="♪";const s=this.element.querySelector(".step-button-indicator");this.element.innerHTML="",this.element.appendChild(e),s&&this.element.appendChild(s);const n=t.canPitch?g[this.stepState.noteIndex]:"♪";this.element.setAttribute("aria-label",`Step ${this.stepIndex+1} - ${t.name} - ${n}`)}createIndicator(){const t=document.createElement("div");t.className="step-button-indicator",this.indicatorSvg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.indicatorSvg.setAttribute("viewBox","0 0 100 100"),this.indicatorSvg.setAttribute("preserveAspectRatio","none"),this.indicatorSvg.style.width="100%",this.indicatorSvg.style.height="100%",this.indicatorSvg.style.position="absolute",this.indicatorSvg.style.top="0",this.indicatorSvg.style.left="0",this.indicatorSvg.style.pointerEvents="none",this.indicatorSvg.style.overflow="visible";const e=50,s=50,n=48,i=n-3;for(let r=0;r<12;r++){const o=(r*30-90)*(Math.PI/180),a=((r+1)*30-90)*(Math.PI/180),c=e+n*Math.cos(o),d=s+n*Math.sin(o),u=e+n*Math.cos(a),m=s+n*Math.sin(a),S=e+i*Math.cos(a),v=s+i*Math.sin(a),f=e+i*Math.cos(o),b=s+i*Math.sin(o),h=document.createElementNS("http://www.w3.org/2000/svg","path"),p=0,C=`
        M ${c} ${d}
        A ${n} ${n} 0 ${p} 1 ${u} ${m}
        L ${S} ${v}
        A ${i} ${i} 0 ${p} 0 ${f} ${b}
        Z
      `.trim();h.setAttribute("d",C),h.setAttribute("fill","#E0E0E0"),h.setAttribute("stroke","none"),h.setAttribute("class",`indicator-segment indicator-segment-${r}`),this.indicatorSvg.appendChild(h),this.indicatorPaths.push(h)}t.appendChild(this.indicatorSvg),this.element.appendChild(t),this.stepState.noteIndex===-1&&(t.style.display="none")}updateIndicator(){if(!this.indicatorSvg||this.indicatorPaths.length===0)return;const t=this.element.querySelector(".step-button-indicator");if(t){if(this.stepState.noteIndex===-1){t.style.display="none";return}t.style.display="block";for(let e=0;e<12;e++){const s=this.indicatorPaths[e];if(s)if(e===this.stepState.noteIndex){const n=l[this.stepState.noteIndex];s.setAttribute("fill",n),s.setAttribute("opacity","1")}else s.setAttribute("fill","#E0E0E0"),s.setAttribute("opacity","0.5")}}}createProgressRing(){const t=document.createElement("div");t.className="step-button-progress-ring";const e=100,s=8,n=(e-s)/2,i=e/2;this.progressPerimeter=2*Math.PI*n,this.progressRingSvg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.progressRingSvg.setAttribute("class","progress-ring-svg"),this.progressRingSvg.setAttribute("viewBox",`0 0 ${e} ${e}`),this.progressRingSvg.style.width="100%",this.progressRingSvg.style.height="100%",this.progressRingSvg.style.position="absolute",this.progressRingSvg.style.top="0",this.progressRingSvg.style.left="0",this.progressRingSvg.style.pointerEvents="none";const r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("cx",String(i)),r.setAttribute("cy",String(i)),r.setAttribute("r",String(n)),r.setAttribute("fill","none"),r.setAttribute("stroke","#e0e0e0"),r.setAttribute("stroke-width",String(s)),this.progressRingBg=r;const o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.setAttribute("cx",String(i)),o.setAttribute("cy",String(i)),o.setAttribute("r",String(n)),o.setAttribute("fill","none"),o.setAttribute("stroke","#4A90E2"),o.setAttribute("stroke-width",String(s)),o.setAttribute("stroke-linecap","round"),this.progressRingPath=o,this.progressRingPath.style.strokeDasharray=`${this.progressPerimeter}`,this.progressRingPath.style.strokeDashoffset=`${this.progressPerimeter}`,this.progressRingPath.style.transition="stroke-dashoffset 0.3s ease, stroke 0.3s ease",this.progressRingPath.style.transform="rotate(90deg)",this.progressRingPath.style.transformOrigin="center",this.progressRingSvg.appendChild(r),this.progressRingSvg.appendChild(o),t.appendChild(this.progressRingSvg),this.progressRingContainer=t,this.wrapper.insertBefore(t,this.element)}updateProgressRing(){if(!(!this.progressRingPath||!this.progressRingContainer))if(!this.stepState.isActive||this.stepState.pressCount===0)this.progressRingContainer.style.opacity="0",this.progressRingPath.style.strokeDashoffset=`${this.progressPerimeter}`;else{this.progressRingContainer.style.opacity="1";const t=this.stepState.pressCount/12,e=this.progressPerimeter-t*this.progressPerimeter;this.progressRingPath.style.strokeDashoffset=`${e}`;const s=l[this.stepState.noteIndex],n=this.darkenColor(s,30);this.progressRingPath.setAttribute("stroke",n)}}darkenColor(t,e){const s=parseInt(t.slice(1,3),16),n=parseInt(t.slice(3,5),16),i=parseInt(t.slice(5,7),16),r=(100-e)/100,o=Math.round(s*r),a=Math.round(n*r),c=Math.round(i*r);return`#${o.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}`}}export{y as S};
