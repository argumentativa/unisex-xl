import{S as b,a as d,b as S,D as C,M as A,P as I,N as v,c as k,A as B,F as L,d as P,e as M}from"./index-C-OTbXo2.js";import{A as q}from"./audio-LGHSRzUS.js";const x=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class N{element;stepIndex;stepState;hue;interactionLevel=0;rowActivity=0;constructor(t,e,n,s){this.stepIndex=t,this.stepState={...e},this.hue=n,this.element=document.createElement("button"),this.element.className="step-button",this.element.setAttribute("data-step",t.toString()),this.element.setAttribute("aria-label",`Step ${t+1}`),this.element.addEventListener("click",()=>{s(t)}),this.updateState()}getElement(){return this.element}setStepState(t){this.stepState={...t},this.updateState()}getStepState(){return{...this.stepState}}getNoteName(){return x[this.stepState.noteIndex]||"C"}setCurrentStep(t){this.element.classList.toggle("current-step",t)}setInteractionLevel(t,e=0){this.interactionLevel=t,this.rowActivity=e,this.updateState()}updateState(){this.element.classList.remove("active","inactive"),this.stepState.isActive?this.element.classList.add("active"):this.element.classList.add("inactive");const t=this.calculateSaturation(),e=this.calculateLightness();this.element.style.setProperty("--step-hue",this.hue.toString()),this.element.style.setProperty("--step-saturation",`${t}%`),this.element.style.setProperty("--step-lightness",`${e}%`),this.element.style.setProperty("--row-activity",this.rowActivity.toString()),this.stepState.isActive?this.element.classList.add("glow-active"):this.element.classList.remove("glow-active");const n=this.getNoteName();this.element.setAttribute("aria-label",`Step ${this.stepIndex+1} - ${n} (${this.stepState.pressCount} presses)`)}calculateSaturation(){return this.stepState.isActive?100:0}calculateLightness(){if(!this.stepState.isActive)return 20;let t=40;switch(this.interactionLevel){case 0:return 30;case 1:t=40;break;case 2:t=55;break;case 3:t=65;break;case 4:t=75;break;case 5:t=85;break;default:t=40}const e=this.rowActivity*15;return Math.min(t+e,90)}}class R{element;instrumentId;pattern;hue;stepButtons;currentStep=-1;interactionLevel=0;rowActivity=0;onStepClick;constructor(t,e,n,s,o){this.instrumentId=t,this.pattern=e,this.hue=n,this.onStepClick=s,this.stepButtons=[],this.element=document.createElement("div"),this.element.className="instrument-row",this.element.setAttribute("data-instrument",t);const r=document.createElement("div");r.className="instrument-label",r.textContent=this.getInstrumentLabel(t),this.element.appendChild(r);const c=document.createElement("div");c.className="steps-container";for(let l=0;l<16;l++){const u=new N(l,e.steps[l],n,s);this.stepButtons.push(u),c.appendChild(u.getElement())}this.element.appendChild(c)}getElement(){return this.element}updateStep(t,e){t>=0&&t<this.stepButtons.length&&this.stepButtons[t].setStepState(e)}updateCurrentStep(t){this.currentStep>=0&&this.currentStep<this.stepButtons.length&&this.stepButtons[this.currentStep].setCurrentStep(!1),this.currentStep=t,this.currentStep>=0&&this.currentStep<this.stepButtons.length&&this.stepButtons[this.currentStep].setCurrentStep(!0)}updateInteractionLevel(t,e=0){this.interactionLevel=t,this.rowActivity=e,this.stepButtons.forEach(n=>{n.setInteractionLevel(t,e)}),this.element.style.setProperty("--row-activity",e.toString()),this.element.classList.toggle("row-active",e>0)}getInstrumentLabel(t){return{synth:"Synth",polySynth:"PolySynth",monoSynth:"MonoSynth",fmSynth:"FMSynth",amSynth:"AMSynth",membraneSynth:"Membrane",noiseSynth:"Noise",snare:"Snare",pluckSynth:"Pluck",metalSynth:"Metal",duoSynth:"DuoSynth",monophonic:"Monophonic",bass:"Bass",drums:"Drums"}[t]||t}}const $=["synth","polySynth","monoSynth","fmSynth","amSynth","membraneSynth","noiseSynth","snare","pluckSynth","metalSynth","duoSynth","monophonic"];function D(i){switch(i){case"synth":return new S({oscillator:{type:"triangle"},envelope:{attack:.005,decay:.1,sustain:.3,release:1}});case"polySynth":return new M(S,{oscillator:{type:"triangle"},envelope:{attack:.005,decay:.1,sustain:.3,release:1}});case"monoSynth":return new P({oscillator:{type:"sawtooth"},envelope:{attack:.01,decay:.2,sustain:.5,release:.8},filterEnvelope:{attack:.01,decay:.1,sustain:.5,release:.5,baseFrequency:200,octaves:2.5}});case"fmSynth":return new L({harmonicity:3,modulationIndex:10,oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:.4,release:.5}});case"amSynth":return new B({harmonicity:3,oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:.4,release:.5}});case"membraneSynth":return new k({pitchDecay:.05,octaves:10,oscillator:{type:"sine"},envelope:{attack:.001,decay:.4,sustain:.01,release:1.4,attackCurve:"exponential"}});case"noiseSynth":return new v({noise:{type:"white"},envelope:{attack:.001,decay:.1,sustain:0,release:.1}});case"snare":return new v({noise:{type:"white"},envelope:{attack:.001,decay:.2,sustain:0,release:.2}});case"pluckSynth":return new I({attackNoise:1,dampening:4e3,resonance:.7});case"metalSynth":return new A({envelope:{attack:.001,decay:.1,release:.01},harmonicity:5.1,modulationIndex:32,resonance:4e3,octaves:1.5});case"duoSynth":return new C({vibratoAmount:.5,vibratoRate:5,harmonicity:1.5,voice0:{oscillator:{type:"sawtooth"},filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5}},voice1:{oscillator:{type:"sawtooth"},filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5}}});case"monophonic":return new S({oscillator:{type:"sawtooth"},envelope:{attack:.01,decay:.1,sustain:.4,release:.5}});default:return new S}}class T{audioEngine;container;patterns;sequences;instrumentRows;currentStep=0;isPlaying=!1;stepIndicatorEventId=null;instruments=$;instrumentInstances=new Map;instrumentColors=new Map([["synth",180],["polySynth",200],["monoSynth",30],["fmSynth",60],["amSynth",90],["membraneSynth",270],["noiseSynth",300],["snare",320],["pluckSynth",150],["metalSynth",240],["duoSynth",0],["monophonic",330]]);constructor(t,e){this.audioEngine=t,this.container=e,this.patterns=[],this.sequences=new Map,this.instrumentRows=new Map,this.instruments.forEach(n=>{this.patterns.push({instrumentId:n,steps:new Array(16).fill(null).map(()=>({noteIndex:0,pressCount:0,isActive:!1}))})})}getInstrumentInstance(t){if(!this.instrumentInstances.has(t)){const e=D(t);e.toDestination(),this.instrumentInstances.set(t,e)}return this.instrumentInstances.get(t)}init(){this.container.innerHTML="",this.instruments.forEach(t=>{const e=this.patterns.find(o=>o.instrumentId===t),n=this.instrumentColors.get(t),s=new R(t,e,n,o=>this.toggleStep(t,o),o=>this.currentStep===o);this.instrumentRows.set(t,s),this.container.appendChild(s.getElement())}),this.updateColors()}toggleStep(t,e){const n=this.patterns.find(r=>r.instrumentId===t);if(!n)return;const s=n.steps[e];s.isActive?(s.noteIndex=(s.noteIndex+1)%12,s.pressCount++,s.pressCount>=12&&(s.isActive=!1,s.noteIndex=0,s.pressCount=0)):(s.noteIndex=0,s.pressCount=0,s.isActive=!0);const o=this.instrumentRows.get(t);o&&o.updateStep(e,s),this.updateSequence(t),this.updateColors()}updateSequence(t){const e=this.patterns.find(a=>a.instrumentId===t);if(!e)return;const n=this.getInstrumentInstance(t);if(!n)return;const s=this.sequences.get(t);s&&(s.stop(),s.dispose());const o=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];let r=4;t==="membraneSynth"||t==="drums"?r=1:t==="noiseSynth"||t==="snare"?r=4:t==="monoSynth"||t==="bass"?r=2:r=4;const c=e.steps.map(a=>a.isActive?`${o[a.noteIndex]}${r}`:null),l=c.some(a=>a!==null);if(l&&console.log(`Creating sequence for ${t} with notes:`,c.filter(a=>a!==null)),!l){const a=this.sequences.get(t);a&&(a.stop(),a.dispose(),this.sequences.delete(t));return}const u=new b((a,y)=>{if(y!==null&&n)try{t==="noiseSynth"||t==="snare"?n.triggerAttackRelease("16n",a):n.triggerAttackRelease(y,"16n",a)}catch(E){console.error(`Error triggering ${t} with note ${y}:`,E)}},c,"16n");this.sequences.set(t,u),this.isPlaying&&u.start(0)}play(){this.isPlaying||(this.isPlaying=!0,this.audioEngine.play(),this.instruments.forEach(t=>{this.updateSequence(t)}),this.sequences.forEach((t,e)=>{t.state==="stopped"?(t.start(0),console.log(`Started sequence for ${e}`)):console.log(`Sequence for ${e} already started (state: ${t.state})`)}),console.log(`Sequencer playing: ${this.sequences.size} sequences active`),this.startStepIndicator())}pause(){this.isPlaying&&this.audioEngine.pause()}stop(){this.isPlaying=!1,this.sequences.forEach(t=>{t.stop(),t.dispose()}),this.sequences.clear(),this.audioEngine.stop(),this.currentStep=0,this.stopStepIndicator(),this.updateStepIndicator()}setBPM(t){this.audioEngine.setBPM(t)}startStepIndicator(){this.stepIndicatorEventId!==null&&(d.clear(this.stepIndicatorEventId),this.stepIndicatorEventId=null),this.currentStep=0,this.stepIndicatorEventId=d.scheduleRepeat(()=>{this.currentStep=(this.currentStep+1)%16,this.updateStepIndicator()},"16n",0),this.updateStepIndicator()}stopStepIndicator(){this.stepIndicatorEventId!==null&&(d.clear(this.stepIndicatorEventId),this.stepIndicatorEventId=null)}updateStepIndicator(){this.instrumentRows.forEach(t=>{t.updateCurrentStep(this.currentStep)})}calculateInteractionLevel(){const t=this.patterns.reduce((e,n)=>e+n.steps.filter(s=>s.isActive).length,0);return t===0?0:t<=4?1:t<=8?2:t<=12?3:4}calculateRowActivityLevel(t){const e=t.steps.filter(n=>n.isActive).length;return Math.min(e/16,1)}updateColors(){const t=this.calculateInteractionLevel();document.body.setAttribute("data-interaction-level",t.toString()),this.instrumentRows.forEach((e,n)=>{const s=this.patterns.find(r=>r.instrumentId===n),o=s?this.calculateRowActivityLevel(s):0;e.updateInteractionLevel(t,o)})}}const f=document.getElementById("playBtn"),w=document.getElementById("pauseBtn"),F=document.getElementById("stopBtn"),G=document.getElementById("bpm"),O=document.getElementById("bpmValue"),h=document.getElementById("statusText"),H=document.getElementById("playbackStatus"),V=document.getElementById("sequencerGrid"),m=new q,p=new T(m,V);function g(i){H.textContent=i,f.classList.toggle("active",i==="Playing"),w.classList.toggle("active",i==="Paused")}f.addEventListener("click",async()=>{try{await m.start(),p.play(),g("Playing"),h.textContent="Playing"}catch(i){h.textContent=`Error: ${i}`,console.error(i)}});w.addEventListener("click",()=>{p.pause(),g("Paused"),h.textContent="Paused"});F.addEventListener("click",()=>{p.stop(),g("Stopped"),h.textContent="Stopped - Click steps to create patterns"});G.addEventListener("input",i=>{const t=parseInt(i.target.value);m.setBPM(t),p.setBPM(t),O.textContent=t.toString(),h.textContent=`BPM: ${t}`});p.init();document.body.setAttribute("data-interaction-level","0");console.log("Step Sequencer initialized");h.textContent="Ready - Click steps to create patterns";
