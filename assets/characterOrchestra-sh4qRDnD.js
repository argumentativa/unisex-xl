import{Q as v}from"./QuickLinks-CczuCusb.js";import{b as d,f as E,e as b,F as w,P,M as k,N as A,c as B,p as m,S as I,a as o,A as R,h as S}from"./utils-DMAVxa_R.js";import{S as q}from"./StepButton-nF8kU9YB.js";function M(c){switch(c.type){case"membrane":return new B({pitchDecay:.05,octaves:10,oscillator:{type:"sine"},envelope:{attack:.001,decay:.4,sustain:.01,release:1.4,attackCurve:"exponential"}});case"noise":return new A({noise:{type:"white"},envelope:{attack:.001,decay:.2,sustain:0,release:.2}});case"metal":return new k({envelope:{attack:.001,decay:.1,release:.01},harmonicity:5.1,modulationIndex:32,resonance:4e3,octaves:1.5});case"synth":return new d({oscillator:{type:"triangle"},envelope:{attack:.005,decay:.1,sustain:.3,release:1}});case"pluck":return new P({attackNoise:1,dampening:4e3,resonance:.7});case"fm":return new w({harmonicity:3,modulationIndex:10,detune:0,oscillator:{type:"sine"},envelope:{attack:.01,decay:.01,sustain:1,release:.5},modulation:{type:"square"},modulationEnvelope:{attack:.5,decay:0,sustain:1,release:.5}});case"mono":return new b({oscillator:{type:"square"},envelope:{attack:.1,decay:.3,sustain:.4,release:.8},filterEnvelope:{attack:.001,decay:.01,sustain:.5,baseFrequency:200,octaves:2.6}});case"poly":return new E(d,{oscillator:{type:"triangle"},envelope:{attack:.02,decay:.1,sustain:.3,release:1}});default:return new d}}const N=[{name:"Boom the Elephant",emoji:"üêò",baseColor:"#ff6b6b",type:"membrane",octave:1,canPitch:!1},{name:"Snap the Squirrel",emoji:"üêøÔ∏è",baseColor:"#4ecdc4",type:"noise",octave:4,canPitch:!1},{name:"Shimmer the Bird",emoji:"üê¶",baseColor:"#ffe66d",type:"metal",octave:4,canPitch:!1},{name:"Melody the Fox",emoji:"ü¶ä",baseColor:"#f38181",type:"synth",octave:4,canPitch:!0},{name:"Pluck the Rabbit",emoji:"üê∞",baseColor:"#95e1d3",type:"pluck",octave:4,canPitch:!0},{name:"Glow the Firefly",emoji:"‚ú®",baseColor:"#aa96da",type:"fm",octave:5,canPitch:!0},{name:"Rumble the Bear",emoji:"üêª",baseColor:"#a8e6cf",type:"mono",octave:2,canPitch:!0},{name:"Chorus the Birds",emoji:"üê¶‚Äç‚¨õ",baseColor:"#fcbad3",type:"poly",octave:4,canPitch:!0}];class j{element;character;pattern;stepButtons;currentStep=-1;emotionalState="sleepy";onStepStateChange;onPlayPreview;constructor(t,e,s,n){this.character=t,this.pattern=e,this.onStepStateChange=s,this.onPlayPreview=n,this.stepButtons=[],this.element=document.createElement("div"),this.element.className="character-row",this.element.setAttribute("data-character",t.name);for(let a=0;a<8;a++){const r=new q(a,e.steps[a],{mode:"character",character:t},{onStateChange:(u,h)=>{this.pattern.steps[u]=h,this.onStepStateChange(u,h)},onPlayPreview:this.onPlayPreview});this.stepButtons.push(r),this.element.appendChild(r.getElement())}}getElement(){return this.element}updateStep(t,e){t>=0&&t<8&&t<this.stepButtons.length&&this.stepButtons[t].setStepState(e)}updateCurrentStep(t){this.currentStep>=0&&this.currentStep<8&&this.currentStep<this.stepButtons.length&&this.stepButtons[this.currentStep].setCurrentStep(!1),this.currentStep=t,this.currentStep>=0&&this.currentStep<8&&this.currentStep<this.stepButtons.length&&this.stepButtons[this.currentStep].setCurrentStep(!0)}updateCharacterState(t){this.emotionalState=t}getStatusEmoji(){switch(this.emotionalState){case"sleepy":return"üí§";case"awake":return"üòä";case"performing":return"üé≠";default:return"üí§"}}}class F{container;audioEngine;characters;patterns;sequences;characterRows;currentStep=0;get isPlaying(){return m.getState()==="playing"}bpm=120;stepIndicatorEventId=null;onStateChangeCallbacks=[];constructor(t,e){this.container=t,this.audioEngine=e||null,this.patterns=[],this.sequences=new Map,this.characterRows=new Map,this.characters=N.map((s,n)=>{const a=M(s);return this.audioEngine?this.audioEngine.connectToEffectChain(a):a.toDestination(),{...s,synth:a,emotionalState:"sleepy",hasActiveSteps:!1}}),this.characters.forEach((s,n)=>{this.patterns.push({characterIndex:n,steps:new Array(8).fill(null).map(()=>({noteIndex:-1,pressCount:0,isActive:!1}))})})}init(){this.container.innerHTML="",this.characters.forEach((t,e)=>{const s=this.patterns[e],n=new j(t,s,(a,r)=>{this.handleStepStateChange(e,a,r)},a=>{this.playPreviewNote(e,a)});this.characterRows.set(e,n),this.container.appendChild(n.getElement())}),this.updateCharacterStates()}handleStepStateChange(t,e,s){const n=this.patterns[t];if(n&&(n.steps[e]=s,this.updateSequence(t),this.updateCharacterStates(),this.notifyStateChange(),this.isPlaying)){const a=this.sequences.get(t);a&&a.state==="stopped"&&a.start(0)}}playPreviewNote(t,e){const s=this.characters[t];if(!s.synth)return;const n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];try{if(s.canPitch&&e>=0){const r=`${n[e]}${s.octave}`;s.synth.triggerAttackRelease(r,"8n")}else s.canPitch||(s.type==="membrane"?s.synth.triggerAttackRelease("C1","8n"):s.synth.triggerAttackRelease("8n"))}catch(a){console.error("Preview sound error:",a)}}updateSequence(t){const e=this.characters[t],s=this.patterns[t];if(!e.synth)return;const n=this.sequences.get(t);n&&(n.stop(),n.dispose());const a=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],r=s.steps.map(i=>i.isActive?e.canPitch&&i.noteIndex>=0?`${a[i.noteIndex]}${e.octave}`:e.canPitch?null:"DRUM":null);if(!r.some(i=>i!==null)){this.sequences.delete(t);return}const h=new I((i,l)=>{if(l!==null&&e.synth)try{l==="DRUM"?e.type==="membrane"?e.synth.triggerAttackRelease("C1","4n",i):e.synth.triggerAttackRelease("4n",i):e.synth.triggerAttackRelease(l,"4n",i)}catch(C){console.error(`Error triggering ${e.name}:`,C)}},r,"8n");this.sequences.set(t,h),this.isPlaying&&h.start(0)}play(){this.isPlaying||(o.start(),o.bpm.value=this.bpm,this.characters.forEach((t,e)=>{this.updateSequence(e)}),this.sequences.forEach((t,e)=>{t.state==="stopped"&&t.start(0)}),this.startStepIndicator(),this.updateCharacterStates())}pause(){this.isPlaying&&(o.pause(),this.updateCharacterStates())}stop(){this.sequences.forEach(t=>{t.stop(),t.dispose()}),this.sequences.clear(),o.stop(),this.currentStep=0,this.stopStepIndicator(),this.updateStepIndicator(),this.updateCharacterStates()}setBPM(t){this.bpm=t,o.bpm.value=t}isPlayingState(){return this.isPlaying}getActiveCharacterCount(){return this.characters.filter(t=>t.hasActiveSteps).length}onCharacterStateChange(t){this.onStateChangeCallbacks.push(t)}notifyStateChange(){this.onStateChangeCallbacks.forEach(t=>t())}updateCharacterStates(){this.characters.forEach((t,e)=>{const n=this.patterns[e].steps.some(r=>r.isActive);t.hasActiveSteps=n,n?this.isPlaying?t.emotionalState="performing":t.emotionalState="awake":t.emotionalState="sleepy";const a=this.characterRows.get(e);a&&a.updateCharacterState(t.emotionalState)})}startStepIndicator(){this.stepIndicatorEventId!==null&&(o.clear(this.stepIndicatorEventId),this.stepIndicatorEventId=null),this.currentStep=0,this.stepIndicatorEventId=o.scheduleRepeat(()=>{this.updateStepIndicator(),this.updateCharacterStates(),this.currentStep=(this.currentStep+1)%8},"8n",0),this.updateStepIndicator()}stopStepIndicator(){this.stepIndicatorEventId!==null&&(o.clear(this.stepIndicatorEventId),this.stepIndicatorEventId=null)}updateStepIndicator(){this.characterRows.forEach(t=>{t.updateCurrentStep(this.currentStep)})}}const T=document.getElementById("characterGrid"),y=document.getElementById("playBtn"),g=document.getElementById("stopBtn"),D=document.getElementById("bpm"),G=document.getElementById("bpmValue"),f=new R,p=new F(T,f);p.init();m.subscribe(c=>{y.classList.toggle("disabled",c==="playing"),g.classList.toggle("disabled",c!=="playing")});S(y,async()=>{await f.start(),p.play()});S(g,()=>{p.stop()});D.addEventListener("input",c=>{const t=parseInt(c.target.value);G.textContent=t.toString(),p.setBPM(t)});console.log("Character Orchestra initialized");v.init("quickLinksContainer");
