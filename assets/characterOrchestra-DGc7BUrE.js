import{Q as m}from"./QuickLinks-B-249s7V.js";import{b as d,e as y,d as S,F as C,P as g,M as v,N as E,c as b,R as w,g as P,i as k,B as A,p as I,S as B,a as o,s as R}from"./utils-BOqQI58-.js";import{S as q}from"./StepButton-DYEnFLtG.js";import{S as M,T as N}from"./TransportControls-CYD71Jxc.js";function D(h){switch(h.type){case"membrane":return new b({pitchDecay:.05,octaves:10,oscillator:{type:"sine"},envelope:{attack:.001,decay:.4,sustain:.01,release:1.4,attackCurve:"exponential"}});case"noise":return new E({noise:{type:"white"},envelope:{attack:.001,decay:.2,sustain:0,release:.2}});case"metal":return new v({envelope:{attack:.001,decay:.1,release:.01},harmonicity:5.1,modulationIndex:32,resonance:4e3,octaves:1.5});case"synth":return new d({oscillator:{type:"triangle"},envelope:{attack:.005,decay:.1,sustain:.3,release:1}});case"pluck":return new g({attackNoise:1,dampening:4e3,resonance:.7});case"fm":return new C({harmonicity:3,modulationIndex:10,detune:0,oscillator:{type:"sine"},envelope:{attack:.01,decay:.01,sustain:1,release:.5},modulation:{type:"square"},modulationEnvelope:{attack:.5,decay:0,sustain:1,release:.5}});case"mono":return new S({oscillator:{type:"square"},envelope:{attack:.1,decay:.3,sustain:.4,release:.8},filterEnvelope:{attack:.001,decay:.01,sustain:.5,baseFrequency:200,octaves:2.6}});case"poly":return new y(d,{oscillator:{type:"triangle"},envelope:{attack:.02,decay:.1,sustain:.3,release:1}});default:return new d}}const F=[{name:"Boom the Elephant",emoji:"üêò",baseColor:"#ff6b6b",type:"membrane",octave:1,canPitch:!1},{name:"Snap the Squirrel",emoji:"üêøÔ∏è",baseColor:"#4ecdc4",type:"noise",octave:4,canPitch:!1},{name:"Shimmer the Bird",emoji:"üê¶",baseColor:"#ffe66d",type:"metal",octave:4,canPitch:!1},{name:"Melody the Fox",emoji:"ü¶ä",baseColor:"#f38181",type:"synth",octave:4,canPitch:!0},{name:"Pluck the Rabbit",emoji:"üê∞",baseColor:"#95e1d3",type:"pluck",octave:4,canPitch:!0},{name:"Glow the Firefly",emoji:"‚ú®",baseColor:"#aa96da",type:"fm",octave:5,canPitch:!0},{name:"Rumble the Bear",emoji:"üêª",baseColor:"#a8e6cf",type:"mono",octave:2,canPitch:!0},{name:"Chorus the Birds",emoji:"üê¶‚Äç‚¨õ",baseColor:"#fcbad3",type:"poly",octave:4,canPitch:!0}];class T{element;character;pattern;stepButtons;currentStep=-1;emotionalState="sleepy";onStepStateChange;onPlayPreview;constructor(e,t,a,n){this.character=e,this.pattern=t,this.onStepStateChange=a,this.onPlayPreview=n,this.stepButtons=[],this.element=document.createElement("div"),this.element.className="character-row",this.element.setAttribute("data-character",e.name);for(let s=0;s<8;s++){const i=new q(s,t.steps[s],{mode:"character",character:e},{onStateChange:(l,c)=>{this.pattern.steps[l]=c,this.onStepStateChange(l,c)},onPlayPreview:this.onPlayPreview});this.stepButtons.push(i),this.element.appendChild(i.getElement())}}getElement(){return this.element}updateStep(e,t){e>=0&&e<8&&e<this.stepButtons.length&&this.stepButtons[e].setStepState(t)}updateCurrentStep(e){this.currentStep>=0&&this.currentStep<8&&this.currentStep<this.stepButtons.length&&this.stepButtons[this.currentStep].setCurrentStep(!1),this.currentStep=e,this.currentStep>=0&&this.currentStep<8&&this.currentStep<this.stepButtons.length&&this.stepButtons[this.currentStep].setCurrentStep(!0)}updateCharacterState(e){this.emotionalState=e}getStatusEmoji(){switch(this.emotionalState){case"sleepy":return"üí§";case"awake":return"üòä";case"performing":return"üé≠";default:return"üí§"}}}class j{constructor(e,t){this.synth=e,this.onEffectChangeCallback=t.onEffectChange,this.initializeEffects(),this.createUI(t),this.connectSynth()}element;header;content;effects=new Map;effectChain=[];isExpanded=!1;reverb;delay;distortion;bitcrusher;effectValues=new Map([["reverb",0],["delay",0],["distortion",0],["bitcrusher",0]]);onEffectChangeCallback;initializeEffects(){this.reverb=new w({decay:2,wet:0}),this.delay=new P({delayTime:"8n",feedback:.2,wet:0}),this.distortion=new k({distortion:0,wet:0}),this.bitcrusher=new A(4),this.bitcrusher.wet.value=0,this.effectChain=[this.distortion,this.bitcrusher,this.delay,this.reverb];for(let e=0;e<this.effectChain.length-1;e++)this.effectChain[e].connect(this.effectChain[e+1]);this.effectChain[this.effectChain.length-1].toDestination()}connectSynth(){this.synth.connect(this.effectChain[0])}createUI(e){this.element=document.createElement("div"),this.element.className="effects-panel",this.element.setAttribute("data-character",e.characterName),this.header=document.createElement("div"),this.header.className="effects-panel-header",this.header.innerHTML=`
      <span class="effects-panel-icon">${e.characterIcon||"üéµ"}</span>
      <span class="effects-panel-name">${e.characterName}</span>
      <span class="effects-panel-toggle">‚ñº</span>
    `,this.header.addEventListener("click",()=>this.toggle()),this.content=document.createElement("div"),this.content.className="effects-panel-content",this.content.style.display="none",this.createEffectControl("reverb","üåä Reverb",0,1,.01),this.createEffectControl("delay","üîÅ Delay",0,1,.01),this.createEffectControl("distortion","üî• Distortion",0,1,.01),this.createEffectControl("bitcrusher","üíé Bitcrusher",0,1,.01),this.element.appendChild(this.header),this.element.appendChild(this.content)}createEffectControl(e,t,a,n,s){const i=document.createElement("div");i.className="effect-control",i.setAttribute("data-effect",e);const l=new M({label:t,min:a,max:n,step:s,value:0,displayFormat:"percentage",onChange:c=>{this.setEffect(e,c),i.classList.toggle("active",c>0)}});i.appendChild(l.getElement()),this.content.appendChild(i)}toggle(){this.isExpanded=!this.isExpanded,this.content.style.display=this.isExpanded?"block":"none";const e=this.header.querySelector(".effects-panel-toggle");e&&(e.textContent=this.isExpanded?"‚ñ≤":"‚ñº"),this.element.classList.toggle("expanded",this.isExpanded)}setEffect(e,t){switch(this.effectValues.set(e,t),e){case"reverb":this.reverb.wet.value=t;break;case"delay":this.delay.wet.value=t;break;case"distortion":this.distortion.wet.value=t;break;case"bitcrusher":this.bitcrusher.wet.value=t;break}this.onEffectChangeCallback&&this.onEffectChangeCallback(e,t)}getElement(){return this.element}dispose(){this.effectChain.forEach(e=>{e.dispose()}),this.synth.disconnect()}}class G{container;characters;patterns;sequences;characterRows;effectsPanels=new Map;currentStep=0;get isPlaying(){return I.getState()==="playing"}bpm=120;stepIndicatorEventId=null;onStateChangeCallbacks=[];constructor(e){this.container=e,this.patterns=[],this.sequences=new Map,this.characterRows=new Map,this.characters=F.map((t,a)=>{const n=D(t);return{...t,synth:n,emotionalState:"sleepy",hasActiveSteps:!1}}),this.characters.forEach((t,a)=>{this.patterns.push({characterIndex:a,steps:new Array(8).fill(null).map(()=>({noteIndex:-1,pressCount:0,isActive:!1}))})})}init(){this.container.innerHTML="",this.characters.forEach((e,t)=>{const a=this.patterns[t],n=new T(e,a,(s,i)=>{this.handleStepStateChange(t,s,i)},s=>{this.playPreviewNote(t,s)});if(this.characterRows.set(t,n),this.container.appendChild(n.getElement()),e.synth){const s=new j(e.synth,{characterName:e.name,characterIcon:e.emoji});this.effectsPanels.set(t,s),this.container.appendChild(s.getElement())}}),this.updateCharacterStates()}handleStepStateChange(e,t,a){const n=this.patterns[e];if(n&&(n.steps[t]=a,this.updateSequence(e),this.updateCharacterStates(),this.notifyStateChange(),this.isPlaying)){const s=this.sequences.get(e);s&&s.state==="stopped"&&s.start(0)}}playPreviewNote(e,t){const a=this.characters[e];if(!a.synth)return;const n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];try{if(a.canPitch&&t>=0){const i=`${n[t]}${a.octave}`;a.synth.triggerAttackRelease(i,"8n")}else a.canPitch||(a.type==="membrane"?a.synth.triggerAttackRelease("C1","8n"):a.synth.triggerAttackRelease("8n"))}catch(s){console.error("Preview sound error:",s)}}updateSequence(e){const t=this.characters[e],a=this.patterns[e];if(!t.synth)return;const n=this.sequences.get(e);n&&(n.stop(),n.dispose());const s=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],i=a.steps.map(r=>r.isActive?t.canPitch&&r.noteIndex>=0?`${s[r.noteIndex]}${t.octave}`:t.canPitch?null:"DRUM":null);if(!i.some(r=>r!==null)){this.sequences.delete(e);return}const c=new B((r,p)=>{if(p!==null&&t.synth)try{p==="DRUM"?t.type==="membrane"?t.synth.triggerAttackRelease("C1","4n",r):t.synth.triggerAttackRelease("4n",r):t.synth.triggerAttackRelease(p,"4n",r)}catch(f){console.error(`Error triggering ${t.name}:`,f)}},i,"8n");this.sequences.set(e,c),this.isPlaying&&c.start(0)}play(){this.isPlaying||(o.start(),o.bpm.value=this.bpm,this.characters.forEach((e,t)=>{this.updateSequence(t)}),this.sequences.forEach((e,t)=>{e.state==="stopped"&&e.start(0)}),this.startStepIndicator(),this.updateCharacterStates())}pause(){this.isPlaying&&(o.pause(),this.updateCharacterStates())}stop(){this.sequences.forEach(e=>{e.stop(),e.dispose()}),this.sequences.clear(),o.stop(),this.currentStep=0,this.stopStepIndicator(),this.updateStepIndicator(),this.updateCharacterStates()}setBPM(e){this.bpm=e,o.bpm.value=e}isPlayingState(){return this.isPlaying}getActiveCharacterCount(){return this.characters.filter(e=>e.hasActiveSteps).length}onCharacterStateChange(e){this.onStateChangeCallbacks.push(e)}notifyStateChange(){this.onStateChangeCallbacks.forEach(e=>e())}updateCharacterStates(){this.characters.forEach((e,t)=>{const n=this.patterns[t].steps.some(i=>i.isActive);e.hasActiveSteps=n,n?this.isPlaying?e.emotionalState="performing":e.emotionalState="awake":e.emotionalState="sleepy";const s=this.characterRows.get(t);s&&s.updateCharacterState(e.emotionalState)})}startStepIndicator(){this.stepIndicatorEventId!==null&&(o.clear(this.stepIndicatorEventId),this.stepIndicatorEventId=null),this.currentStep=0,this.stepIndicatorEventId=o.scheduleRepeat(()=>{this.updateStepIndicator(),this.updateCharacterStates(),this.currentStep=(this.currentStep+1)%8},"8n",0),this.updateStepIndicator()}stopStepIndicator(){this.stepIndicatorEventId!==null&&(o.clear(this.stepIndicatorEventId),this.stepIndicatorEventId=null)}updateStepIndicator(){this.characterRows.forEach(e=>{e.updateCurrentStep(this.currentStep)})}dispose(){this.effectsPanels.forEach(e=>e.dispose()),this.effectsPanels.clear(),this.sequences.forEach(e=>{e.stop(),e.dispose()}),this.sequences.clear(),this.stopStepIndicator()}}const L=document.getElementById("characterGrid"),$=document.getElementById("transportControlsContainer"),u=new G(L);u.init();const O=new N({initialBPM:120,onPlay:async()=>{await R(),u.play()},onStop:()=>{u.stop()},onBPMChange:h=>{u.setBPM(h)}});$.appendChild(O.getElement());console.log("Character Orchestra initialized");m.init("quickLinksContainer");
