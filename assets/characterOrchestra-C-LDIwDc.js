import{b as u,e as d,d as m,F as f,P as C,M as g,N as v,c as P,S as w,a as c,i as E,s as b}from"./index-cqQ3Oiz6.js";import{S as k}from"./StepButton-BIgP0YQh.js";function A(l){switch(l.type){case"membrane":return new P({pitchDecay:.05,octaves:10,oscillator:{type:"sine"},envelope:{attack:.001,decay:.4,sustain:.01,release:1.4,attackCurve:"exponential"}});case"noise":return new v({noise:{type:"white"},envelope:{attack:.001,decay:.2,sustain:0,release:.2}});case"metal":return new g({envelope:{attack:.001,decay:.1,release:.01},harmonicity:5.1,modulationIndex:32,resonance:4e3,octaves:1.5});case"synth":return new u({oscillator:{type:"triangle"},envelope:{attack:.005,decay:.1,sustain:.3,release:1}});case"pluck":return new C({attackNoise:1,dampening:4e3,resonance:.7});case"fm":return new f({harmonicity:3,modulationIndex:10,detune:0,oscillator:{type:"sine"},envelope:{attack:.01,decay:.01,sustain:1,release:.5},modulation:{type:"square"},modulationEnvelope:{attack:.5,decay:0,sustain:1,release:.5}});case"mono":return new m({oscillator:{type:"square"},envelope:{attack:.1,decay:.3,sustain:.4,release:.8},filterEnvelope:{attack:.001,decay:.01,sustain:.5,baseFrequency:200,octaves:2.6}});case"poly":return new d(u,{oscillator:{type:"triangle"},envelope:{attack:.02,decay:.1,sustain:.3,release:1}});default:return new u}}const I=[{name:"Boom the Elephant",emoji:"üêò",baseColor:"#ff6b6b",type:"membrane",octave:1,canPitch:!1},{name:"Snap the Squirrel",emoji:"üêøÔ∏è",baseColor:"#4ecdc4",type:"noise",octave:4,canPitch:!1},{name:"Shimmer the Bird",emoji:"üê¶",baseColor:"#ffe66d",type:"metal",octave:4,canPitch:!1},{name:"Melody the Fox",emoji:"ü¶ä",baseColor:"#f38181",type:"synth",octave:4,canPitch:!0},{name:"Pluck the Rabbit",emoji:"üê∞",baseColor:"#95e1d3",type:"pluck",octave:4,canPitch:!0},{name:"Glow the Firefly",emoji:"‚ú®",baseColor:"#aa96da",type:"fm",octave:5,canPitch:!0},{name:"Rumble the Bear",emoji:"üêª",baseColor:"#a8e6cf",type:"mono",octave:2,canPitch:!0},{name:"Chorus the Birds",emoji:"üê¶‚Äç‚¨õ",baseColor:"#fcbad3",type:"poly",octave:4,canPitch:!0}];class R{element;character;pattern;stepButtons;currentStep=-1;emotionalState="sleepy";onStepStateChange;onPlayPreview;constructor(t,e,a,s){this.character=t,this.pattern=e,this.onStepStateChange=a,this.onPlayPreview=s,this.stepButtons=[],this.element=document.createElement("div"),this.element.className="character-row",this.element.setAttribute("data-character",t.name);for(let n=0;n<16;n++){const r=new k(n,e.steps[n],{mode:"character",character:t},{onStateChange:(p,o)=>{this.pattern.steps[p]=o,this.onStepStateChange(p,o)},onPlayPreview:this.onPlayPreview});this.stepButtons.push(r),this.element.appendChild(r.getElement())}}getElement(){return this.element}updateStep(t,e){t>=0&&t<16&&t<this.stepButtons.length&&this.stepButtons[t].setStepState(e)}updateCurrentStep(t){this.currentStep>=0&&this.currentStep<16&&this.currentStep<this.stepButtons.length&&this.stepButtons[this.currentStep].setCurrentStep(!1),this.currentStep=t,this.currentStep>=0&&this.currentStep<16&&this.currentStep<this.stepButtons.length&&this.stepButtons[this.currentStep].setCurrentStep(!0)}updateCharacterState(t){this.emotionalState=t}getStatusEmoji(){switch(this.emotionalState){case"sleepy":return"üí§";case"awake":return"üòä";case"performing":return"üé≠";default:return"üí§"}}}class B{container;characters;patterns;sequences;characterRows;currentStep=0;isPlaying=!1;bpm=120;stepIndicatorEventId=null;onStateChangeCallbacks=[];constructor(t){this.container=t,this.patterns=[],this.sequences=new Map,this.characterRows=new Map,this.characters=I.map((e,a)=>{const s=A(e);return s.toDestination(),{...e,synth:s,emotionalState:"sleepy",hasActiveSteps:!1}}),this.characters.forEach((e,a)=>{this.patterns.push({characterIndex:a,steps:new Array(16).fill(null).map(()=>({noteIndex:-1,pressCount:0,isActive:!1}))})})}init(){this.container.innerHTML="",this.characters.forEach((t,e)=>{const a=this.patterns[e],s=new R(t,a,(n,r)=>{this.handleStepStateChange(e,n,r)},n=>{this.playPreviewNote(e,n)});this.characterRows.set(e,s),this.container.appendChild(s.getElement())}),this.updateCharacterStates()}handleStepStateChange(t,e,a){const s=this.patterns[t];s&&(s.steps[e]=a,this.updateSequence(t),this.updateCharacterStates(),this.notifyStateChange(),this.isPlaying||this.play())}playPreviewNote(t,e){const a=this.characters[t];if(!a.synth)return;const s=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];try{if(a.canPitch&&e>=0){const r=`${s[e]}${a.octave}`;a.synth.triggerAttackRelease(r,"16n")}else a.canPitch||(a.type==="membrane"?a.synth.triggerAttackRelease("C1","16n"):a.synth.triggerAttackRelease("16n"))}catch(n){console.error("Preview sound error:",n)}}updateSequence(t){const e=this.characters[t],a=this.patterns[t];if(!e.synth)return;const s=this.sequences.get(t);s&&(s.stop(),s.dispose());const n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],r=a.steps.map(i=>i.isActive?e.canPitch&&i.noteIndex>=0?`${n[i.noteIndex]}${e.octave}`:e.canPitch?null:"DRUM":null);if(!r.some(i=>i!==null)){this.sequences.delete(t);return}const o=new w((i,h)=>{if(h!==null&&e.synth)try{h==="DRUM"?e.type==="membrane"?e.synth.triggerAttackRelease("C1","4n",i):e.synth.triggerAttackRelease("4n",i):e.synth.triggerAttackRelease(h,"4n",i)}catch(y){console.error(`Error triggering ${e.name}:`,y)}},r,"16n");this.sequences.set(t,o),this.isPlaying&&o.start(0)}play(){this.isPlaying||(this.isPlaying=!0,c.start(),c.bpm.value=this.bpm,this.characters.forEach((t,e)=>{this.updateSequence(e)}),this.sequences.forEach((t,e)=>{t.state==="stopped"&&t.start(0)}),this.startStepIndicator(),this.updateCharacterStates())}pause(){this.isPlaying&&(c.pause(),this.isPlaying=!1,this.updateCharacterStates())}stop(){this.isPlaying=!1,this.sequences.forEach(t=>{t.stop(),t.dispose()}),this.sequences.clear(),c.stop(),this.currentStep=0,this.stopStepIndicator(),this.updateStepIndicator(),this.updateCharacterStates()}setBPM(t){this.bpm=t,c.bpm.value=t}isPlayingState(){return this.isPlaying}getActiveCharacterCount(){return this.characters.filter(t=>t.hasActiveSteps).length}onCharacterStateChange(t){this.onStateChangeCallbacks.push(t)}notifyStateChange(){this.onStateChangeCallbacks.forEach(t=>t())}updateCharacterStates(){this.characters.forEach((t,e)=>{const s=this.patterns[e].steps.some(r=>r.isActive);t.hasActiveSteps=s,s?this.isPlaying?t.emotionalState="performing":t.emotionalState="awake":t.emotionalState="sleepy";const n=this.characterRows.get(e);n&&n.updateCharacterState(t.emotionalState)})}startStepIndicator(){this.stepIndicatorEventId!==null&&(c.clear(this.stepIndicatorEventId),this.stepIndicatorEventId=null),this.currentStep=0,this.stepIndicatorEventId=c.scheduleRepeat(()=>{this.updateStepIndicator(),this.updateCharacterStates(),this.currentStep=(this.currentStep+1)%16},"16n",0),this.updateStepIndicator()}stopStepIndicator(){this.stepIndicatorEventId!==null&&(c.clear(this.stepIndicatorEventId),this.stepIndicatorEventId=null)}updateStepIndicator(){this.characterRows.forEach(t=>{t.updateCurrentStep(this.currentStep)})}}const q=document.getElementById("characterGrid"),S=new B(q);S.init();document.addEventListener("click",async()=>{E.state!=="running"&&(await b(),S.play())},{once:!0});console.log("Character Orchestra initialized");
