import{Q as b}from"./QuickLinks-DrpVojna.js";import{A}from"./audio-CjUdy6Ak.js";import{p as f,S as B,a as d,b as S,D as k,M as I,P as q,N as g,c as P,A as M,F as L,d as R,e as x,h as m}from"./utils-BOqQI58-.js";import{S as N}from"./StepButton-nF8kU9YB.js";class ${element;instrumentId;pattern;hue;stepButtons;currentStep=-1;interactionLevel=0;rowActivity=0;onStepStateChange;onPlayPreview;constructor(t,e,s,n,a){this.instrumentId=t,this.pattern=e,this.hue=s,this.onStepStateChange=n,this.onPlayPreview=a,this.stepButtons=[],this.element=document.createElement("div"),this.element.className="instrument-row",this.element.setAttribute("data-instrument",t);const o=document.createElement("div");o.className="instrument-label",o.textContent=this.getInstrumentLabel(t),this.element.appendChild(o);const c=document.createElement("div");c.className="steps-container";for(let l=0;l<16;l++){const u=new N(l,e.steps[l],{mode:"hue",hue:s},{onStateChange:(i,h)=>{this.pattern.steps[i]=h,this.onStepStateChange(i,h)},onPlayPreview:this.onPlayPreview});this.stepButtons.push(u),c.appendChild(u.getElement())}this.element.appendChild(c)}getElement(){return this.element}updateStep(t,e){t>=0&&t<this.stepButtons.length&&this.stepButtons[t].setStepState(e)}updateCurrentStep(t){this.currentStep>=0&&this.currentStep<this.stepButtons.length&&this.stepButtons[this.currentStep].setCurrentStep(!1),this.currentStep=t,this.currentStep>=0&&this.currentStep<this.stepButtons.length&&this.stepButtons[this.currentStep].setCurrentStep(!0)}updateInteractionLevel(t,e=0){this.interactionLevel=t,this.rowActivity=e,this.stepButtons.forEach(s=>{s.setInteractionLevel(t,e)}),this.element.style.setProperty("--row-activity",e.toString()),this.element.classList.toggle("row-active",e>0)}getInstrumentLabel(t){return{synth:"Synth",polySynth:"PolySynth",monoSynth:"MonoSynth",fmSynth:"FMSynth",amSynth:"AMSynth",membraneSynth:"Membrane",noiseSynth:"Noise",snare:"Snare",pluckSynth:"Pluck",metalSynth:"Metal",duoSynth:"DuoSynth",monophonic:"Monophonic",bass:"Bass",drums:"Drums"}[t]||t}}const T=["synth","polySynth","monoSynth","fmSynth","amSynth","membraneSynth","noiseSynth","snare","pluckSynth","metalSynth","duoSynth","monophonic"];function D(r){switch(r){case"synth":return new S({oscillator:{type:"triangle"},envelope:{attack:.005,decay:.1,sustain:.3,release:1}});case"polySynth":return new x(S,{oscillator:{type:"triangle"},envelope:{attack:.005,decay:.1,sustain:.3,release:1}});case"monoSynth":return new R({oscillator:{type:"sawtooth"},envelope:{attack:.01,decay:.2,sustain:.5,release:.8},filterEnvelope:{attack:.01,decay:.1,sustain:.5,release:.5,baseFrequency:200,octaves:2.5}});case"fmSynth":return new L({harmonicity:3,modulationIndex:10,oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:.4,release:.5}});case"amSynth":return new M({harmonicity:3,oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:.4,release:.5}});case"membraneSynth":return new P({pitchDecay:.05,octaves:10,oscillator:{type:"sine"},envelope:{attack:.001,decay:.4,sustain:.01,release:1.4,attackCurve:"exponential"}});case"noiseSynth":return new g({noise:{type:"white"},envelope:{attack:.001,decay:.1,sustain:0,release:.1}});case"snare":return new g({noise:{type:"white"},envelope:{attack:.001,decay:.2,sustain:0,release:.2}});case"pluckSynth":return new q({attackNoise:1,dampening:4e3,resonance:.7});case"metalSynth":return new I({envelope:{attack:.001,decay:.1,release:.01},harmonicity:5.1,modulationIndex:32,resonance:4e3,octaves:1.5});case"duoSynth":return new k({vibratoAmount:.5,vibratoRate:5,harmonicity:1.5,voice0:{oscillator:{type:"sawtooth"},filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5}},voice1:{oscillator:{type:"sawtooth"},filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5}}});case"monophonic":return new S({oscillator:{type:"sawtooth"},envelope:{attack:.01,decay:.1,sustain:.4,release:.5}});default:return new S}}class F{audioEngine;container;patterns;sequences;instrumentRows;currentStep=0;get isPlaying(){return f.getState()==="playing"}stepIndicatorEventId=null;instruments=T;instrumentInstances=new Map;instrumentColors=new Map([["synth",180],["polySynth",200],["monoSynth",30],["fmSynth",60],["amSynth",90],["membraneSynth",270],["noiseSynth",300],["snare",320],["pluckSynth",150],["metalSynth",240],["duoSynth",0],["monophonic",330]]);constructor(t,e){this.audioEngine=t,this.container=e,this.patterns=[],this.sequences=new Map,this.instrumentRows=new Map,this.instruments.forEach(s=>{this.patterns.push({instrumentId:s,steps:new Array(16).fill(null).map(()=>({noteIndex:0,pressCount:0,isActive:!1}))})})}getInstrumentInstance(t){if(!this.instrumentInstances.has(t)){const e=D(t);this.audioEngine.connectToEffectChain(e),this.instrumentInstances.set(t,e)}return this.instrumentInstances.get(t)}init(){this.container.innerHTML="",this.instruments.forEach(t=>{const e=this.patterns.find(a=>a.instrumentId===t),s=this.instrumentColors.get(t),n=new $(t,e,s,(a,o)=>{this.handleStepStateChange(t,a,o)},a=>{this.playPreviewNote(t,a)});this.instrumentRows.set(t,n),this.container.appendChild(n.getElement())}),this.updateColors()}handleStepStateChange(t,e,s){const n=this.patterns.find(a=>a.instrumentId===t);n&&(n.steps[e]=s,this.updateSequence(t),this.updateColors(),this.isPlaying||this.play())}playPreviewNote(t,e){const s=this.getInstrumentInstance(t);if(!s)return;const n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];let a=4;t==="membraneSynth"||t==="drums"?a=1:(t==="monoSynth"||t==="bass")&&(a=2);const c=`${n[e]}${a}`;try{t==="noiseSynth"||t==="snare"?s.triggerAttackRelease("16n"):s.triggerAttackRelease(c,"16n")}catch(l){console.error(`Error playing preview for ${t}:`,l)}}toggleStep(t,e){const s=this.patterns.find(o=>o.instrumentId===t);if(!s)return;const n=s.steps[e];n.isActive?(n.noteIndex=(n.noteIndex+1)%12,n.pressCount++,n.pressCount>=12&&(n.isActive=!1,n.noteIndex=0,n.pressCount=0)):(n.noteIndex=0,n.pressCount=0,n.isActive=!0);const a=this.instrumentRows.get(t);a&&a.updateStep(e,n),this.updateSequence(t),this.updateColors()}updateSequence(t){const e=this.patterns.find(i=>i.instrumentId===t);if(!e)return;const s=this.getInstrumentInstance(t);if(!s)return;const n=this.sequences.get(t);n&&(n.stop(),n.dispose());const a=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];let o=4;t==="membraneSynth"||t==="drums"?o=1:t==="noiseSynth"||t==="snare"?o=4:t==="monoSynth"||t==="bass"?o=2:o=4;const c=e.steps.map(i=>i.isActive?`${a[i.noteIndex]}${o}`:null),l=c.some(i=>i!==null);if(l&&console.log(`Creating sequence for ${t} with notes:`,c.filter(i=>i!==null)),!l){const i=this.sequences.get(t);i&&(i.stop(),i.dispose(),this.sequences.delete(t));return}const u=new B((i,h)=>{if(h!==null&&s)try{t==="noiseSynth"||t==="snare"?s.triggerAttackRelease("16n",i):s.triggerAttackRelease(h,"16n",i)}catch(C){console.error(`Error triggering ${t} with note ${h}:`,C)}},c,"16n");this.sequences.set(t,u),this.isPlaying&&u.start(0)}play(){this.isPlaying||(this.audioEngine.play(),this.instruments.forEach(t=>{this.updateSequence(t)}),this.sequences.forEach((t,e)=>{t.state==="stopped"?(t.start(0),console.log(`Started sequence for ${e}`)):console.log(`Sequence for ${e} already started (state: ${t.state})`)}),console.log(`Sequencer playing: ${this.sequences.size} sequences active`),this.startStepIndicator())}pause(){this.isPlaying&&this.audioEngine.pause()}stop(){this.sequences.forEach(t=>{t.stop(),t.dispose()}),this.sequences.clear(),this.audioEngine.stop(),this.currentStep=0,this.stopStepIndicator(),this.updateStepIndicator()}setBPM(t){this.audioEngine.setBPM(t)}startStepIndicator(){this.stepIndicatorEventId!==null&&(d.clear(this.stepIndicatorEventId),this.stepIndicatorEventId=null),this.currentStep=0,this.stepIndicatorEventId=d.scheduleRepeat(()=>{this.currentStep=(this.currentStep+1)%16,this.updateStepIndicator()},"16n",0),this.updateStepIndicator()}stopStepIndicator(){this.stepIndicatorEventId!==null&&(d.clear(this.stepIndicatorEventId),this.stepIndicatorEventId=null)}updateStepIndicator(){this.instrumentRows.forEach(t=>{t.updateCurrentStep(this.currentStep)})}calculateInteractionLevel(){const t=this.patterns.reduce((e,s)=>e+s.steps.filter(n=>n.isActive).length,0);return t===0?0:t<=4?1:t<=8?2:t<=12?3:4}calculateRowActivityLevel(t){const e=t.steps.filter(s=>s.isActive).length;return Math.min(e/16,1)}updateColors(){const t=this.calculateInteractionLevel();document.body.setAttribute("data-interaction-level",t.toString()),this.instrumentRows.forEach((e,s)=>{const n=this.patterns.find(o=>o.instrumentId===s),a=n?this.calculateRowActivityLevel(n):0;e.updateInteractionLevel(t,a)})}}const v=document.getElementById("playBtn"),w=document.getElementById("pauseBtn"),G=document.getElementById("stopBtn"),O=document.getElementById("bpm"),H=document.getElementById("bpmValue"),p=document.getElementById("statusText"),V=document.getElementById("playbackStatus"),_=document.getElementById("sequencerGrid"),E=new A,y=new F(E,_);f.subscribe(r=>{const t=r.charAt(0).toUpperCase()+r.slice(1);V.textContent=t,v.classList.toggle("active",r==="playing"),w.classList.toggle("active",r==="paused")});m(v,async()=>{try{await E.start(),y.play(),p.textContent="Playing"}catch(r){p.textContent=`Error: ${r}`,console.error(r)}});m(w,()=>{y.pause(),p.textContent="Paused"});m(G,()=>{y.stop(),p.textContent="Stopped - Click steps to create patterns"});O.addEventListener("input",r=>{const t=parseInt(r.target.value);y.setBPM(t),H.textContent=t.toString(),p.textContent=`BPM: ${t}`});y.init();document.body.setAttribute("data-interaction-level","0");console.log("Step Sequencer initialized");p.textContent="Ready - Click steps to create patterns";b.init("quickLinksContainer");
