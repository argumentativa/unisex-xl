<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strudel + ASCII Visualizer Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff00;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            height: 100vh;
            gap: 0;
        }

        .left-panel {
            background: #0a0a0a;
            border-right: 2px solid #00ff00;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .right-panel {
            background: #000;
            position: relative;
        }

        .controls {
            padding: 20px;
            background: #111;
            border-bottom: 2px solid #00ff00;
        }

        .code-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            background: #00ff00;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        button:hover {
            background: #00cc00;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        button.stop {
            background: #ff0000;
        }

        button.stop:hover {
            background: #cc0000;
        }

        pre {
            color: #00ff00;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #00ff00;
        }

        .info {
            color: #888;
            font-size: 12px;
            margin-top: 10px;
        }

        canvas {
            display: block !important;
        }

        #visualizer {
            width: 100%;
            height: 100%;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }

            .left-panel {
                border-right: none;
                border-bottom: 2px solid #00ff00;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- LEFT PANEL: Strudel Code -->
        <div class="left-panel">
            <div class="controls">
                <div class="title">üéµ STRUDEL LIVE CODING</div>
                <button id="startStrudel">‚ñ∂Ô∏è START PATTERN</button>
                <button id="stopStrudel" class="stop">‚èπÔ∏è STOP</button>
                <div class="info">Industrial 157 BPM Pattern</div>
            </div>
            <div class="code-area">
                <pre id="code">// Industrial Pattern - 157 BPM
setcps(0.654) // 157 BPM

stack(
  // Industrial bass with heavy filtering
  note("b1 e2 b1 d3 b1 b2 b1 b1 b2 b1 b2 b1 b2 a2 b1 b2")
    .slow(2)
    .transpose("<0 0 0 5 7>")
    .s("supersaw")
    .distort(0.4)
    .lpf(300)
    .gain(0.8)
    .crush("<16 3>"),

  // Aggressive kick with filtering
  s("bd ~ bd ~")
    .gain(1.2)
    .lpf(800)
    .distort(0.3),

  // Snare with distortion
  s("~ cp ~ cp")
    .gain(0.65)
    .distort(0.2)
    .lpf(2000),

  // Noise hi-hats
  s("~ ~ hh ~")
    .hpf(8000)
    .gain(0.2)
    .decay(0.05)
)</pre>
            </div>
        </div>

        <!-- RIGHT PANEL: ASCII Visualizer -->
        <div class="right-panel">
            <div id="visualizer"></div>
        </div>
    </div>

    <!-- Load Libraries -->
    <script src="../libraries/p5.min.js"></script>
    <script src="https://unpkg.com/@strudel/web@1.0.3"></script>

    <!-- Strudel Control Script -->
    <script>
        let isPlaying = false;
        let currentPattern = null;

        // Initialize Strudel on page load
        initStrudel();

        document.getElementById('startStrudel').addEventListener('click', async () => {
            if (!isPlaying) {
                try {
                    // Get the code from the pre element
                    const code = document.getElementById('code').textContent;

                    // Evaluate and play the pattern using Strudel's API
                    // The pattern needs .play() called on it
                    currentPattern = await evaluate(code);

                    isPlaying = true;
                    console.log('‚ñ∂Ô∏è Pattern started!');

                    // Update UI
                    document.getElementById('startStrudel').style.background = '#ffff00';
                    document.getElementById('startStrudel').textContent = 'üîä PLAYING';
                } catch (error) {
                    console.error('Error starting pattern:', error);
                    alert('Error: ' + error.message);
                }
            }
        });

        document.getElementById('stopStrudel').addEventListener('click', () => {
            if (isPlaying) {
                hush(); // Strudel's stop function
                isPlaying = false;
                console.log('‚èπÔ∏è Pattern stopped');

                // Update UI
                document.getElementById('startStrudel').style.background = '#00ff00';
                document.getElementById('startStrudel').textContent = '‚ñ∂Ô∏è START PATTERN';
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+Enter or Cmd+Enter to play
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('startStrudel').click();
            }
            // Ctrl+. or Cmd+. to stop
            if ((e.ctrlKey || e.metaKey) && e.key === '.') {
                e.preventDefault();
                document.getElementById('stopStrudel').click();
            }
        });
    </script>

    <!-- ASCII Visualizer Script -->
    <script>
        // Modified version of image-ascii-color-bold.js
        // Adapted to work in split-screen layout with Strudel

        let img;
        let size;
        let asciiChar = "‚ñà‚ñì‚ñí‚ñë$@B%8&WM#*oahkbdpqwmZO0QLCJUYXzcvunxrjft/\\|()1{}[]?-_+~<>i!lI;:,^`'. ";
        let w = 100;
        let h = 75;

        // Web Audio API analyzers (native, not Tone.js)
        let analyser, dataArray;
        let startButton;
        let audioStarted = false;

        // Audio reactive values
        let bass = 0, mid = 0, treble = 0, volume = 0;
        let bassSmooth = 0, volumeSmooth = 0;

        function preload() {
            img = loadImage("../assets/dandy.jpg");
        }

        function setup() {
            img.resize(w, 0);
            h = img.height;

            // Create canvas in the right panel
            let visualizer = document.getElementById('visualizer');
            let canvasWidth = visualizer.offsetWidth;
            let canvasHeight = visualizer.offsetHeight;

            let canvas = createCanvas(canvasWidth, canvasHeight);
            canvas.parent('visualizer');

            size = width / img.width;
            textStyle(BOLD);

            // Create start button
            startButton = createButton('üéµ START VISUALIZER');
            startButton.position(20, 20);
            startButton.mousePressed(startAudio);
            startButton.style('padding', '15px 30px');
            startButton.style('font-size', '16px');
            startButton.style('background', '#00ff00');
            startButton.style('border', 'none');
            startButton.style('border-radius', '10px');
            startButton.style('cursor', 'pointer');
            startButton.style('font-weight', 'bold');
            startButton.style('z-index', '1000');
            startButton.style('position', 'absolute');
        }

        async function startAudio() {
            if (!audioStarted) {
                // Get Strudel's audio context
                let audioContext;
                try {
                    audioContext = getAudioContext();
                    console.log('Got Strudel audio context');
                } catch (e) {
                    // Fallback: create our own context
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('Created fallback audio context');
                }

                // Resume if suspended
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                // Create analyser node
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.8;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                // Connect analyser to destination (for passthrough)
                analyser.connect(audioContext.destination);

                // Try to intercept Strudel's output by replacing the destination
                // Strudel's superdough synth engine exposes its output
                if (typeof getDestination === 'function') {
                    try {
                        const strudelDest = getDestination();
                        // Disconnect from original destination and route through analyser
                        strudelDest.disconnect();
                        strudelDest.connect(analyser);
                        console.log('‚úÖ Connected Strudel destination to analyser');
                    } catch (e) {
                        console.log('Could not intercept Strudel destination:', e);
                    }
                }

                audioStarted = true;
                startButton.html('üîä VISUALIZING');
                startButton.style('background', '#ff00ff');

                console.log('‚úÖ Visualizer ready! Start a pattern to see audio reactivity.');
            }
        }

        function getFrequencyEnergy(lowFreq, highFreq) {
            if (!analyser || !dataArray) return 0;

            analyser.getByteFrequencyData(dataArray);

            const nyquist = 22050; // Approximate
            const binCount = dataArray.length;
            const lowBin = Math.floor((lowFreq / nyquist) * binCount);
            const highBin = Math.floor((highFreq / nyquist) * binCount);

            let sum = 0, count = 0;
            for (let i = lowBin; i <= highBin && i < binCount; i++) {
                sum += dataArray[i];
                count++;
            }

            return count > 0 ? sum / count : 0;
        }

        function getVolume() {
            if (!analyser || !dataArray) return 0;

            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            return sum / dataArray.length / 255; // Normalize to 0-1
        }

        function draw() {
            background(0);

            if (audioStarted && analyser) {
                // Get frequency bands using native Web Audio
                bass = getFrequencyEnergy(20, 250);
                mid = getFrequencyEnergy(250, 4000);
                treble = getFrequencyEnergy(4000, 20000);
                volume = getVolume();

                bassSmooth = lerp(bassSmooth, bass, 0.3);
                volumeSmooth = lerp(volumeSmooth, volume, 0.2);
            }

            img.loadPixels();

            for (let i = 0; i < img.width; i++) {
                for (let j = 0; j < img.height; j++) {
                    let pixelVal = img.get(i, j);
                    let bright = brightness(pixelVal);

                    if (audioStarted) {
                        let volumeBoost = map(volumeSmooth, 0, 0.5, 0, 50);
                        bright = bright + volumeBoost;
                        let trebleBoost = map(treble, 0, 255, 0, 30);
                        bright = map(bright, 0, 255, trebleBoost, 255 - trebleBoost);
                        bright = constrain(bright, 0, 255);
                    }

                    let tIndex = floor(map(bright, 0, 255, asciiChar.length - 1, 0));
                    let x = i * size + size / 2;
                    let y = j * size + size / 2;
                    let t = asciiChar.charAt(tIndex);

                    let charSize = size * 1.1;
                    if (audioStarted) {
                        let bassPulse = map(bassSmooth, 0, 255, 1.0, 1.3);
                        charSize = charSize * bassPulse;
                        let wave = sin((i + j) * 0.1 + frameCount * 0.05) * 0.5 + 0.5;
                        let midEffect = map(mid, 0, 255, 1.0, 1.15);
                        charSize = charSize * (1 + (wave * (midEffect - 1)));
                    }

                    textSize(charSize);
                    textAlign(CENTER, CENTER);

                    let r = red(pixelVal);
                    let g = green(pixelVal);
                    let b = blue(pixelVal);

                    if (audioStarted) {
                        r = r + map(bassSmooth, 0, 255, 0, 40);
                        g = g + map(mid, 0, 255, 0, 30);
                        b = b + map(treble, 0, 255, 0, 35);
                        r = constrain(r, 0, 255);
                        g = constrain(g, 0, 255);
                        b = constrain(b, 0, 255);
                    }

                    fill(r, g, b);

                    let strokeW = 0.8;
                    if (audioStarted) {
                        strokeW = map(volumeSmooth, 0, 0.5, 0.5, 1.5);
                        if (treble > 180) {
                            stroke(255, 255, 255, map(treble, 180, 255, 0, 150));
                            strokeWeight(strokeW * 1.5);
                        } else {
                            stroke(r, g, b);
                            strokeWeight(strokeW);
                        }
                    } else {
                        stroke(r, g, b);
                        strokeWeight(strokeW);
                    }

                    text(t, x, y);
                }
            }

            noStroke();

            if (audioStarted) {
                drawAudioDebug();
            }
        }

        function drawAudioDebug() {
            push();
            fill(0, 0, 0, 180);
            noStroke();
            rect(10, height - 150, 250, 140, 10);
            
            fill(255);
            textSize(14);
            textAlign(LEFT, TOP);
            textStyle(BOLD);
            text('AUDIO LEVELS', 20, height - 140);
            
            textStyle(NORMAL);
            textSize(12);
            
            fill(255, 50, 50);
            rect(20, height - 115, map(bassSmooth, 0, 255, 0, 200), 20, 3);
            fill(255);
            text(`BASS: ${Math.floor(bassSmooth)}`, 20, height - 93);
            
            fill(50, 255, 50);
            rect(20, height - 75, map(mid, 0, 255, 0, 200), 20, 3);
            fill(255);
            text(`MID: ${Math.floor(mid)}`, 20, height - 53);
            
            fill(50, 50, 255);
            rect(20, height - 35, map(treble, 0, 255, 0, 200), 20, 3);
            fill(255);
            text(`TREBLE: ${Math.floor(treble)}`, 20, height - 13);
            
            pop();
        }

        function windowResized() {
            let visualizer = document.getElementById('visualizer');
            let canvasWidth = visualizer.offsetWidth;
            let canvasHeight = visualizer.offsetHeight;
            resizeCanvas(canvasWidth, canvasHeight);
            size = width / img.width;
        }
    </script>
</body>
</html>

