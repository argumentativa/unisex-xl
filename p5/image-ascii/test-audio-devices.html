<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Audio Device Test</title>
  <style>
    body {
      background: #000;
      color: #0f0;
      font-family: monospace;
      padding: 20px;
    }
    button {
      background: #0f0;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 0;
    }
    #info {
      background: #111;
      padding: 20px;
      margin: 20px 0;
      border: 2px solid #0f0;
    }
    .device {
      background: #222;
      padding: 10px;
      margin: 5px 0;
      border-left: 3px solid #0f0;
    }
    canvas {
      border: 2px solid #0f0;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>üé§ Audio Device Debugger</h1>

  <button onclick="listDevices()">1Ô∏è‚É£ List Available Devices</button>
  <button onclick="testBlackHole()">2Ô∏è‚É£ Test BlackHole Audio</button>

  <div id="info"></div>
  <canvas id="visualizer" width="800" height="200"></canvas>

  <script src="../libraries/p5.min.js"></script>
  <script src="../libraries/p5.sound.min.js"></script>

  <script>
    let mic, fft, amp;
    let canvas, ctx;

    function setup() {
      noCanvas();
      canvas = document.getElementById('visualizer');
      ctx = canvas.getContext('2d');
    }

    async function listDevices() {
      const info = document.getElementById('info');
      info.innerHTML = '<h2>üìã Available Audio Input Devices:</h2>';

      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const audioInputs = devices.filter(d => d.kind === 'audioinput');

        if (audioInputs.length === 0) {
          info.innerHTML += '<p style="color: red;">‚ùå No audio input devices found!</p>';
          return;
        }

        audioInputs.forEach((device, i) => {
          const isBlackHole = device.label.toLowerCase().includes('blackhole');
          const color = isBlackHole ? '#ff0' : '#0f0';
          info.innerHTML += `
            <div class="device" style="border-color: ${color}">
              <strong>${i + 1}. ${device.label || 'Unknown Device'}</strong><br>
              ID: ${device.deviceId}<br>
              ${isBlackHole ? '‚≠ê This is BlackHole!' : ''}
            </div>
          `;
        });

        const hasBlackHole = audioInputs.some(d =>
          d.label.toLowerCase().includes('blackhole')
        );

        if (!hasBlackHole) {
          info.innerHTML += '<p style="color: red;">‚ö†Ô∏è BlackHole not found! Is it installed?</p>';
        }

      } catch (err) {
        info.innerHTML += `<p style="color: red;">‚ùå Error: ${err.message}</p>`;
      }
    }

    async function testBlackHole() {
      const info = document.getElementById('info');
      info.innerHTML = '<h2>üéµ Testing BlackHole Audio...</h2>';

      try {
        // Request audio input
        info.innerHTML += '<p>üì¢ Select BlackHole 2ch when prompted!</p>';

        mic = new p5.AudioIn();
        mic.start();

        // Wait a moment for mic to initialize
        await new Promise(resolve => setTimeout(resolve, 1000));

        fft = new p5.FFT(0.8, 512);
        fft.setInput(mic);

        amp = new p5.Amplitude();
        amp.setInput(mic);

        info.innerHTML += '<p style="color: #0f0;">‚úÖ Audio input started!</p>';
        info.innerHTML += '<p>üéµ Now play some audio through your Multi-Output Device</p>';
        info.innerHTML += '<p>üìä Watch the visualizer below - it should show activity if audio is flowing</p>';

        // Start visualizing
        visualize();

      } catch (err) {
        info.innerHTML += `<p style="color: red;">‚ùå Error: ${err.message}</p>`;
      }
    }

    function visualize() {
      if (!fft || !amp) return;

      requestAnimationFrame(visualize);

      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Get audio data
      const spectrum = fft.analyze();
      const level = amp.getLevel();
      const bass = fft.getEnergy("bass");
      const mid = fft.getEnergy("mid");
      const treble = fft.getEnergy("treble");

      // Draw spectrum
      ctx.strokeStyle = '#0f0';
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i = 0; i < spectrum.length; i++) {
        const x = map(i, 0, spectrum.length, 0, canvas.width);
        const y = map(spectrum[i], 0, 255, canvas.height, 0);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // Draw frequency bars
      const barWidth = canvas.width / 3;

      // Bass (red)
      ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
      ctx.fillRect(0, canvas.height - (bass / 255) * canvas.height, barWidth - 10, (bass / 255) * canvas.height);

      // Mid (green)
      ctx.fillStyle = 'rgba(0, 255, 0, 0.7)';
      ctx.fillRect(barWidth, canvas.height - (mid / 255) * canvas.height, barWidth - 10, (mid / 255) * canvas.height);

      // Treble (blue)
      ctx.fillStyle = 'rgba(0, 0, 255, 0.7)';
      ctx.fillRect(barWidth * 2, canvas.height - (treble / 255) * canvas.height, barWidth - 10, (treble / 255) * canvas.height);

      // Labels
      ctx.fillStyle = '#fff';
      ctx.font = '14px monospace';
      ctx.fillText(`BASS: ${Math.floor(bass)}`, 10, 20);
      ctx.fillText(`MID: ${Math.floor(mid)}`, barWidth + 10, 20);
      ctx.fillText(`TREBLE: ${Math.floor(treble)}`, barWidth * 2 + 10, 20);
      ctx.fillText(`LEVEL: ${level.toFixed(3)}`, 10, canvas.height - 10);
    }

    function map(value, start1, stop1, start2, stop2) {
      return start2 + (stop2 - start2) * ((value - start1) / (stop1 - start1));
    }
  </script>
</body>
</html>
